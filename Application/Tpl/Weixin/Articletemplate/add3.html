<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>微社区系统</title>

<link rel="stylesheet" href="/static2/plugin/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/static2/plugin/fontawesome/css/font-awesome4.min.css">
<link rel="stylesheet" href="/static2/css/style.css">
<link rel="stylesheet" href="/static2/css/theme.css">
<link rel="stylesheet" href="/static2/plugin/fastArticle/style.css">
</head>

<body>
<!-- 头部 -->
<include file="header" />
<!-- 头部 -->


<!-- 左侧菜单 -->
<div class="j-gloab-menus">
  <a href="" class="item">
    <div class="j-h15 j-m"></div>
    <span class="fa fa-home"></span><br>
    <span>系统首页</span>
  </a>
  
  <a href="" class="item active">
    <div class="j-h15 j-m"></div>
    <span class="fa fa-th-large"></span><br>
    <span>功能管理</span>
  </a>
  
  <a href="" class="item">
    <div class="j-h15 j-m"></div>
    <span class="fa fa-cog"></span><br>
    <span>社区管理</span>
  </a>
</div>
<!-- 左侧菜单 -->


<!-- 右侧内容 -->
<div class="j-gloab-content">
  <!-- box -->
  <form method="post" id="form1" action="" enctype="multipart/form-data">
  <div class="box">
    <div class="box-title">快速发布</div>
    <div class="j-m j-h1 j-bkcl2"></div>
    <div class="box-content">
      <div class="j-article-fastadd">
        <table class="j-table no-padding">
          <tbody>
            <tr>
              <td><input class="fastadd-input" name="title" id="title" type="text" placeholder="请输入文章标题"></td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="j-h15 j-m"></div>
      <div class="j-article-fastadd">
        <table class="j-table no-padding">
          <tbody>
            <tr>
              <td width="200">
                <div class="j-upload" id="cover">
                  <div class="status">0%</div>
                  <img src="/Public/images/default02/sqzx.jpg">
                  <input type="hidden" id="show_bg_img" name="show_bg_img" value="{$detail.picurl|default='/Public/images/default02/sqzx.jpg'}">
                </div>
              </td>
              <td class="vb">
                <label class="j-upload-input j-ml8">
                  <a class="btn">上传封面</a>
                  <input type="file" onchange="upload(this)" process="cover" accept="image/jpeg,image/x-png">
                </label>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="j-h15 j-m"></div>
      
      <!-- editor -->
      <div class="j-article-fastadd" id="fast-editor">
        <div class="fast-editor">
          
          <div fast-type="p" style="text-indent: 2em">文章内容</div>
          
          <div fast-type="img">
            <img class="aim-img" src="/static2/image/head_pic.jpg">
            <div style="text-align:center; width:80%; margin:0 auto">
              描述内容
            </div>
          </div>
        </div>
      </div>
      <!-- editor -->
      <div class="j-article-fastadd">
        <div class="form-group">
          <table>
            <tr>
              <td class="msg-label">文章分类</td>
              <td>
                <select name="cid" id="cattype" class="j-w-100">
                    <option value="">未分类</option>
                    <volist name="catlist" id="catitem">
                    <option value="{$catitem.id}" pid="{$catitem.category_id}">{$catitem.sty}{$catitem.classname}</option>
                    </volist>
                </select>
              </td>
            </tr>
            
            <tr>
              <td class="msg-label">链接应用</td>
              <td>
                <select class="sm" name="type" id="type" onchange="typechange1()">
                  <option value="">无</option>
                  <option value="link">链接</option>
                  <option value="business">业务模块</option>
                </select>
                （群发信息后通过阅读原文链接到某个活动应用）
              </td>
            </tr>
            
            <tr class="type j-hide" id="type-link">
              <td class="msg-label">链接</td>
              <td><input type="text"></td>
            </tr>
            
            <tr class="type j-hide" id="type-business">
              <td class="msg-label">业务模块</td>
              <td>
                <select id="business_type" name="business_type" onchange="typechange2()">
                  <option value="huodong">报名活动</option>
                  <option value="huodonglist">报名活动列表</option>
                </select>
                <a class="btn btn-info j-hide type2" id="type2-huodonglist" href="#myModal" data-toggle="modal">
                  <span class="fa fa-plus"></span> 选择项目
                </a>
              </td>
            </tr>
            
            <tr class="list-select j-hide">
              <td class="msg-label"></td>
              <td class="list-select-content"></td>
            </tr>
            
            <tr>
              <td colspan="2" class="j-txtct">
                <input id="isdatalist" name="isdatalist" type="hidden" value="-1">
                <a class="j-button-red" onclick="submit(this)">提交</a>
              </td>
            </tr>
          </table>
          <textarea id="editor" name="content" style="display: none;"></textarea>
        </div>
      </div>
      <div class="j-m"></div>
    </div>
  </div>
  </form>
  <!-- boxend -->
  
  <!-- footer -->
  <div class="j-m j-h20"></div>
  <div class="j-footer">
    <ul>
      <li><a>关于我们</a></li>
      <li><a>通知中心</a></li>
      <li><a>使用指南</a></li>
      <li>Copyright © 2012-2015 All Rights Reserved.</li>
    </ul>
  </div>
  <div class="j-m j-h20"></div>
  <!-- footer -->
</div>
<!-- 右侧内容 -->

<!-- 弹窗 -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">项目选择</h3>
  </div>
  <div class="modal-body">
    <div id="users" class="list-controls article-list-page" page="0" requestUrl="{:U('xianmu/ajax')}" off="0" key="">
      <table class="j-table">
        <tbody>
          <tr>
            <td width="50">项目：</td>
            <td colspan="2"><input type="text" class="search-keyinput j-w95"></td>
            <td><a class="btn" onclick="DialogList.search(this,htmldeal)">搜索</a></td>
          </tr>
          <tr>
            <td width="50"></td>
            <td>共<span class="total">0</span>条符合条件</td>
            <td>
              <a class="page-btn" onclick="DialogList.page_pre(this,htmldeal)">上一页</a>
              <span>
                第
                <span class="nowpage">0</span>
                页/共
                <span class="totalpage"></span>
                页
              </span>
              <a class="page-btn page-btn-next" onclick="DialogList.page_next(this,htmldeal)">下一页</a>
            </td>
            <td></td>
          </tr>
        </tbody>
      </table>
      
      <div class="list-container">
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
    <button class="btn btn-info" data-dismiss="modal" aria-hidden="true">确定</button>
  </div>
</div>
<!-- 弹窗 -->

<!--js-->
<script src="/static2/js/jquery.js"></script>
<script src="/static2/plugin/bootstrap/js/bootstrap.min.js"></script>
<script src="/static2/js/site.js"></script>
<script src="/static2/js/upload.js"></script>
<script src="/static2/plugin/fastArticle/fastedit.js"></script>
<!--js-->
<script>
//J_FastEdit.init('#fast-editor',{manage:false,edit:false});
J_FastEdit.init('#fast-editor',{manage:false,edit:false});
function test(){
  console.log(J_FastEdit.getcode('#fast-editor'));
}

function upload(a){
  if(J_Uploader.isruning==true){
    J_msgshow("正在上传请稍等");
    return false;
	}
  
  upload.process='#'+$(a).attr("process");
  J_Uploader.reset();
  J_Uploader.upload_url="{:U('image/up')}"; //上传地址
  
  J_Uploader.process=function(p){
    //console.log(p);
    $(upload.process).find(".status").css("width",p+'%').html(p+"%");
  }
  
  J_Uploader.callback	=function(data){
    //console.log(data);
    if(data.statu!=1){
      $(upload.process).find(".status").html(J_Uploader.error[data.statu]);
      return false;
    }
    
    $(upload.process).find(".status").html('上传成功');
    $(upload.process).find('img').prop("src",data.path+'?t='+Math.random());
	$("#show_bg_img").val(data.path);
  };
  
  J_Uploader.uploading=function(){
    
  }
  
  
  J_Uploader.file=a.files;
  J_Uploader.nowtype="image";
  J_Uploader.addlist();
}

//活动选择
var DialogList={};

DialogList.getparent=function(a){
  return $(a).parent().parent().parent().parent().parent();
}

DialogList.loaddata=function(a,callback){
  var aim=DialogList.getparent(a);
  
  aim.attr("status","1");
  var page=aim.attr("page");
  var requestUrl=aim.attr("requestUrl");
  var key=aim.attr("key");
  
  aim.find(".list-container").html('<div class="loading">加载中..</div>');
  
  console.log(requestUrl);
  
  $.post(requestUrl,{
    p:page,
    keyword:key,
    btype:$('#business_type').val(),
  },function(data){
    aim.attr("status","0");
    aim.find(".list-container").html('');
    
    callback(data);
  },"json");
}

DialogList.page_next=function(a,callback){
  var aim=DialogList.getparent(a);
  var page=parseInt(aim.attr("page"));
  var total=aim.find(".totalpage").html();
  total=total=="" ? 1 : parseInt(total);
  var status=aim.attr("status");
  
  if(page>=total){
    return;
  }
  
  if(status==1){
    return;
  }
  
  page++;
  aim.attr("page",page);
  aim.find(".nowpage").html(page);
  DialogList.loaddata(a,callback);
}

DialogList.page_pre=function(a,callback){
  var aim=DialogList.getparent(a);
  var page=parseInt(aim.attr("page"));
  var total=aim.find(".totalpage").html();
  total=total=="" ? 1 : parseInt(total);
  var status=aim.attr("status");
  
  if(page<=1){
    return;
  }
  
  if(status==1){
    return;
  }
  
  page--;
  aim.attr("page",page);
  aim.find(".nowpage").html(page);
  DialogList.loaddata(a,callback);
}

DialogList.search=function(a,callback){
  var aim=DialogList.getparent(a);
  var keyword=aim.find(".search-keyinput").val();
  
  aim.attr("page",1);
  aim.find(".nowpage").html(1);
  aim.attr("key",keyword);
  
  DialogList.loaddata(a,callback);
}

DialogList.itemselect=function(a){
  var aim=DialogList.getparent(a);
  aim.find(".list-controls").find(".item").removeClass("selected");

  $(a).addClass("selected");
  var checkbox=$(a).find("input");
  
  var id=checkbox.attr("articleid");
  var title=checkbox.attr("title");
  
  var html='<div class="input-prepend"><input name="xiamuids[]" type="hidden" value="'+ id +'"><span class="add-on">'+ title +'</span><a class="btn" onclick="xianm_delete(this)"><span class="icon-remove"></span></a></div>';
    
  $(".list-select-content").html(html);
}

DialogList.init=function(){
  $(".list-container .item").live("click",function(){
    DialogList.itemselect(this)
  });
}
DialogList.init();

function submit(a){
  $(a).prop("disabled",true).html('提交中...');
  $('#editor').html(J_FastEdit.getcode('#fast-editor'));
  $('#form1').submit();
}

function typechange1(){
  var type=$('#type').val();
  
  $(".type").hide();
  if(type!=""){
    $("#type-"+type).show();
  }
  
  typechange2();
}

function typechange2(){
  var type=$('#business_type').val();
  
  $(".list-select").hide();
  $(".type2").hide();
  $("#isdatalist").val("-1");
  
  if(type!=""){
    $("#type2-"+type).show();
  }
  
  if(type=="huodonglist" && $('#type').val()=="business"){
    $(".list-select").show();
    $("#isdatalist").val("1");
  }
}

function xianm_delete(a){
  var id=$(a).parent().find("input").val();
  $("#users input[articleid='"+id+"']").prop("checked",'').parent().parent().parent().parent().parent().removeClass("selected");
  $(a).parent().remove();
}

function htmldeal(data){
  var list=data.list;
  
  $("#users .total").html(data.total);
  $("#users .totalpage").html(Math.ceil(parseInt(data.total)/15));
  
  for(var i=0;i<list.length;i++){
    var item=list[i];
    
    var html='<label class="item"><table class="j-table"><tbody><tr><td><input type="radio" name="articleid[]" articleid="'+ item.id +'" title="'+ item.title +'" value="'+ item.id +'"></td><td width="80"><img src="'+ item.picurl +'"></td><td>'+ item.title +'</td></tr></tbody></table></label>';
    $(".list-container").append(html);
  }
}

$(document).ready(function(){
  $("#type2-huodonglist").on("click",function(){
    $(this).off();
    
    DialogList.page_next($("#users .page-btn-next")[0],htmldeal);
  });
});
</script>
</body>
</html>
